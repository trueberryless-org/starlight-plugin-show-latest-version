---
import { logos } from 'virtual:starlight/user-images';
import config from 'virtual:starlight/user-config';
import pluginConfig from 'virtual:starlight-plugin-show-latest-version-config';
import type { Props } from '../props';
import { Badge } from '@astrojs/starlight/components';
const { siteTitle, siteTitleHref } = Astro.props;

const fetchVersion = async () => {
  const repo = pluginConfig.repo;
  const apiUrl = `https://api.github.com/repos/${repo}/releases/latest`;

  try {
    const data = await fetch(apiUrl)
      .then(response => {
        if (!response.ok) throw new Error(`Failed to fetch: ${response.statusText}`);
        return response.json();
      });

    // Extract and normalize the version
    const tagName = data.tag_name || '';
    const match = tagName.match(/(?:.*@)?(?<version>[0-9]+\.[0-9]+\.[0-9]+)/);
    return match ? `v${match.groups.version}` : 'v0.0.0';
  } catch (error) {
    console.error(error);
    return 'v0.0.0'; // Fallback version
  }
};

const version = await fetchVersion();
---

<a href={siteTitleHref} class="site-title sl-flex">
	{
		config.logo && logos.dark && (
			<>
				<img
					class:list={{ 'light:sl-hidden': !('src' in config.logo) }}
					alt={config.logo.alt}
					src={logos.dark.src}
					width={logos.dark.width}
					height={logos.dark.height}
				/>
				{/* Show light alternate if a user configure both light and dark logos. */}
				{!('src' in config.logo) && (
					<img
						class="dark:sl-hidden"
						alt={config.logo.alt}
						src={logos.light?.src}
						width={logos.light?.width}
						height={logos.light?.height}
					/>
				)}
			</>
		)
	}
	<span class:list={{ 'sr-only': config.logo?.replacesTitle }}>
		{siteTitle}
	</span>
  {version && (
    <starlight-plugin-show-latest-version>
      <a href="https://github.com/trueberryless-org/starlight-cooler-credit/releases/latest" class="starlight-plugin-show-latest-version-link">
        <Badge text={version} variant={pluginConfig.badge.variant} size={pluginConfig.badge.size} class='starlight-plugin-show-latest-version-badge'/>
      </a>
    </starlight-plugin-show-latest-version>
  )}
</a>


<style>
	.site-title {
		align-items: center;
		gap: var(--sl-nav-gap);
		font-size: var(--sl-text-h4);
		font-weight: 600;
		color: var(--sl-color-text-accent);
		text-decoration: none;
		white-space: nowrap;
	}
	img {
		height: calc(var(--sl-nav-height) - 2 * var(--sl-nav-pad-y));
		width: auto;
		max-width: 100%;
		object-fit: contain;
		object-position: 0 50%;
	}
  .starlight-plugin-show-latest-version-link {
    display: flex;
    align-items: center;
    text-decoration: none;
  }
</style>
